<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, interactive-widget=resizes-content">
  <title>textarea</title>
  
  <!-- Math & Code Libraries -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">

  <style>
    :root { --bg: #fff; --txt: #161616; --ui: rgba(0,0,0,0.05); --acc: #007aff; }
    [data-theme="dark"] { --bg: #0b0b0b; --txt: #d1d1d1; --ui: rgba(255,255,255,0.1); --acc: #ff9500; }
    [data-theme="sepia"] { --bg: #f4ecd8; --txt: #5b4636; --ui: rgba(0,0,0,0.05); --acc: #8c6a5a; }
    [data-theme="midnight"] { --bg: #000; --txt: #fff; --ui: rgba(255,255,255,0.15); --acc: #5e5ce6; }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--txt); height: 100%; font-family: ui-monospace, system-ui, sans-serif; transition: 0.3s; overflow: hidden; }
    
    article {
      outline: none; padding: 80px max(20px, calc(50vw - 350px));
      height: 100vh; line-height: 1.6; font-size: 18px;
      white-space: pre-wrap; overflow-wrap: break-word; overflow-y: auto;
    }
    
    /* Navigation */
    .nav { position: fixed; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 100; transition: 0.3s; }
    button { 
      background: var(--ui); border: none; color: var(--txt); padding: 8px 12px; 
      border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 500;
    }
    button.active { background: var(--txt); color: var(--bg); }

    /* Sidebar & Search */
    #sidebar {
      position: fixed; left: -300px; top: 0; width: 300px; height: 100%;
      background: var(--bg); border-right: 1px solid var(--ui); z-index: 200;
      padding: 60px 20px; transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    }
    #sidebar.open { left: 0; box-shadow: 20px 0 50px rgba(0,0,0,0.2); }
    
    #search {
      width: 100%; background: var(--ui); border: 1px solid rgba(128,128,128,0.2);
      padding: 10px; color: var(--txt); border-radius: 8px; margin-bottom: 15px;
      outline: none; font-size: 14px;
    }

    #note-list { max-height: calc(100% - 200px); overflow-y: auto; }
    .note-item { 
      padding: 12px; border-radius: 8px; margin-bottom: 8px; 
      background: var(--ui); cursor: pointer; font-size: 13px; 
      display: flex; justify-content: space-between; align-items: center;
    }
    .note-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; }

    /* Markdown Styles */
    .wikilink { color: var(--acc); text-decoration: underline; cursor: pointer; }
    img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
    pre[class*="language-"] { border-radius: 8px; margin: 1em 0; }

    footer { position: fixed; bottom: 15px; left: 15px; font-size: 11px; opacity: 0.4; pointer-events: none; }
    
    @media print { .nav, footer, #sidebar { display: none; } article { padding: 0; } }
  </style>
</head>
<body data-theme="light">

<div id="sidebar">
  <input type="text" id="search" placeholder="Search #tags or notes..." oninput="renderLibrary()">
  <button onclick="dailyNote()" style="width: 100%; margin-bottom: 15px;">ðŸ“… Today</button>
  
  <div id="note-list"></div>
  
  <div style="position: absolute; bottom: 20px; width: 260px; display: flex; gap: 5px;">
    <button onclick="exportJSON()" style="flex: 1;">Export</button>
    <button onclick="importJSON()" style="flex: 1;">Import</button>
  </div>
</div>

<div class="nav" id="nav">
  <button onclick="toggleSidebar()">library</button>
  <button onclick="cycleTheme()">vibe</button>
  <button id="view-btn" onclick="toggleView()">render</button>
  <button onclick="copyLink()">share</button>
</div>

<article contenteditable="plaintext-only" spellcheck="true" autofocus></article>

<footer><span id="stats">0w</span></footer>

<script>
  const article = document.querySelector('article');
  const viewBtn = document.getElementById('view-btn');
  const themes = ['light', 'dark', 'sepia', 'midnight'];
  let isRendered = false;
  let rawContent = "";

  // 1. Core Logic: Save & Load
  async function save() {
    if (isRendered) return;
    const text = article.textContent;
    const hash = '#' + await compress(text);
    if (location.hash !== hash) {
      history.replaceState(null, '', hash);
      localStorage.setItem('hash', hash);
    }
    updateUI();
    
    // Auto-update Library Entry
    const notes = JSON.parse(localStorage.getItem('notes-db') || '[]');
    const title = text.trim().split('\n')[0].replace('#', '').trim() || 'Untitled';
    const index = notes.findIndex(n => n.hash === hash);
    const tags = text.match(/#\w+/g) || [];
    
    if (index > -1) {
      notes[index].title = title;
      notes[index].tags = tags;
    } else {
      notes.unshift({ title, hash, tags, date: Date.now() });
    }
    localStorage.setItem('notes-db', JSON.stringify(notes.slice(0, 100)));
    renderLibrary();
  }

  async function load() {
    const hash = location.hash || localStorage.getItem('hash');
    if (hash) {
      try { article.textContent = await decompress(hash.slice(1)); } catch (e) {}
    }
    updateUI();
  }

  // 2. Library & Search
  function renderLibrary() {
    const query = document.getElementById('search').value.toLowerCase();
    const notes = JSON.parse(localStorage.getItem('notes-db') || '[]');
    const container = document.getElementById('note-list');
    
    const filtered = notes.filter(n => 
      n.title.toLowerCase().includes(query) || 
      (n.tags && n.tags.some(t => t.toLowerCase().includes(query)))
    );

    container.innerHTML = filtered.map(n => `
      <div class="note-item" onclick="location.hash='${n.hash}'; toggleSidebar();">
        <span>${n.title}</span>
        <small style="opacity:0.3; padding: 5px;" onclick="deleteNote('${n.hash}'); event.stopPropagation();">Ã—</small>
      </div>
    `).join('');
  }

  function deleteNote(hash) {
    let notes = JSON.parse(localStorage.getItem('notes-db') || '[]');
    notes = notes.filter(n => n.hash !== hash);
    localStorage.setItem('notes-db', JSON.stringify(notes));
    renderLibrary();
  }

  // 3. Smart Typing (Checkboxes, Indents, Lists)
  article.addEventListener('keydown', e => {
    if (isRendered) return;
    if (e.key === 'Enter') {
      const sel = window.getSelection();
      const range = sel.getRangeAt(0);
      const text = range.startContainer.textContent.substring(0, range.startOffset);
      const line = text.split('\n').pop();
      const match = line.match(/^(\s*([-*]|\[[ x]\]|\d+\.)\s*)/);
      if (match) {
        e.preventDefault();
        let marker = match[0];
        if (marker.match(/\d+/)) marker = marker.replace(/\d+/, m => parseInt(m) + 1);
        document.execCommand('insertText', false, '\n' + marker);
      }
    }
  });

  article.onclick = (e) => {
    if (isRendered) return;
    const range = document.caretRangeFromPoint(e.clientX, e.clientY);
    if (!range) return;
    const text = range.startContainer.textContent;
    const offset = range.startOffset;
    if (text.substring(offset-1, offset+2).match(/\[[ x]\]/)) {
      const isChecked = text.substring(offset-1, offset+2) === '[x]';
      range.startContainer.textContent = text.substring(0, offset-1) + (isChecked ? '[ ]' : '[x]') + text.substring(offset+2);
      if (navigator.vibrate) navigator.vibrate(20);
      save();
    }
  };

  // 4. Rendering (Math, Code, Wiki)
  function toggleView() {
    isRendered = !isRendered;
    viewBtn.classList.toggle('active', isRendered);
    if (isRendered) {
      rawContent = article.textContent;
      let html = rawContent.replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/\[\[(.*?)\]\]/g, (m, name) => `<span class="wikilink" onclick="openNote('${name}')">[[${name}]]</span>`)
        .replace(/```(\w+)?\n([\s\S]+?)\n```/g, (m, lang, code) => `<pre class="language-${lang||'clike'}"><code>${code}</code></pre>`)
        .replace(/\$\$([\s\S]+?)\$\$/g, (m, mth) => `<div class="math-block">${mth}</div>`)
        .replace(/\$([^\n$]+?)\$/g, (m, mth) => `<span class="math-inline">${mth}</span>`);
      article.innerHTML = html;
      article.contentEditable = false;
      if (window.Prism) Prism.highlightAllUnder(article);
      document.querySelectorAll('.math-block').forEach(el => katex.render(el.textContent, el, { displayMode: true }));
      document.querySelectorAll('.math-inline').forEach(el => katex.render(el.textContent, el, { displayMode: false }));
    } else {
      article.contentEditable = 'plaintext-only';
      article.textContent = rawContent;
      article.focus();
    }
  }

  function openNote(name) {
    const notes = JSON.parse(localStorage.getItem('notes-db') || '[]');
    const note = notes.find(n => n.title.toLowerCase() === name.toLowerCase());
    if (note) location.hash = note.hash;
    else { article.textContent = `# ${name}\n\n`; save(); }
    if(isRendered) toggleView();
  }

  function dailyNote() {
    const name = new Date().toISOString().split('T')[0];
    openNote(name);
    toggleSidebar();
  }

  // 5. Utilities
  function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
  function cycleTheme() {
    const cur = document.body.getAttribute('data-theme');
    const next = themes[(themes.indexOf(cur) + 1) % themes.length];
    document.body.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  }

  function updateUI() {
    const text = article.textContent.trim();
    document.getElementById('stats').textContent = `${text ? text.split(/\s+/).length : 0}w`;
    
    // Focus Mode Logic
    document.getElementById('nav').classList.add('hide');
    clearTimeout(window.typeTimer);
    window.typeTimer = setTimeout(() => document.getElementById('nav').classList.remove('hide'), 1000);
  }

  async function compress(s) {
    const b = new TextEncoder().encode(s);
    const st = new CompressionStream('deflate-raw');
    const w = st.writable.getWriter(); w.write(b); w.close();
    const r = await new Response(st.readable).arrayBuffer();
    return btoa(String.fromCharCode(...new Uint8Array(r))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  async function decompress(n) {
    const s = atob(n.replace(/-/g, '+').replace(/_/g, '/'));
    const b = Uint8Array.from(s, c => c.charCodeAt(0));
    const st = new DecompressionStream('deflate-raw');
    const w = st.writable.getWriter(); w.write(b); w.close();
    const r = await new Response(st.readable).arrayBuffer();
    return new TextDecoder().decode(r);
  }

  function copyLink() { navigator.clipboard.writeText(location.href); alert('Link copied'); }
  
  const debounce = (f, ms) => { let t; return () => { clearTimeout(t); t = setTimeout(f, ms); }; };
  article.oninput = debounce(save, 500);
  window.onhashchange = () => { if(!isRendered) load(); };
  window.onload = () => { load(); renderLibrary(); document.body.setAttribute('data-theme', localStorage.getItem('theme')||'light'); };
  
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
